<html lang="en">

<head>
  <title>Dublin Bikes</title>
  <meta charset="utf-8" name="viewport" content="initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static',filename='css/mycss.css') }}">
  <script src="static/javascript/chart.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
</head>


<body>
<header>
  <img id='logo' src="/static/images/Dublin_Bikes_logo.jpg">
  <h1>Dublin Bikes</a></h1>
  <div class="col">
    <a class="current"></a>
  </div>

</header>

<!--Navbar container-->
<div class="nav">
  {% for item in holidaylist %}
  <div class='holidayinfo'><p class='infoicon'><img class='infoicon' src="/static/images/information.svg" width="26px" height="26px">&nbsp;{{ item }}</p></div>
  {% endfor %}
</div>
  

<div class="row">

  <!-- Side menu container -->
  <div class="margin">
    <div class="dropdown">
      <form id="selections" action="{{ url_for('graphs') }}" method = "POST">
        <br/>
        <p id='maintext'>Select a station on the map to view the most recent information.<br/><br/>Otherwise, choose a station from the dropdown to view the predicted availability.<br/><br/><br/>View predicted availability by:</p>
        <form id="radio" action="{{ url_for('graphs') }}" method = "POST">
          <div class = "radioselect"><input type='radio' name='radio' value='available_bikes' checked>&nbsp;&nbsp;&nbsp;&nbsp; Available bikes<br/>
          <input type='radio' name='radio' value='available_bike_stands'>&nbsp;&nbsp;&nbsp;&nbsp; Available stands<br/></div>
          <select id='list' type="text" name="id" action="" method = "POST">
            <option value='108'>Avondale Road </option>
            <option value='70'>Barrow Street </option>
            <option value='90'>Benson Street </option>
            <option value='88'>Blackhall Place </option>
            <option value='2'>Blessington Street </option>
            <option value='3'>Bolton Street </option>
            <option value='84'>Brookfield Road </option>
            <option value='109'>Buckingham Street Lower </option>
            <option value='24'>Cathal Brugha Street </option>
            <option value='5'>Charlemont Street </option>
            <option value='107'>Charleville Road </option>
            <option value='6'>Christchurch Place </option>
            <option value='99'>City Quay </option>
            <option value='54'>Clonmel Street </option>
            <option value='87'>Collins Barracks Museum </option>
            <option value='65'>Convention Centre </option>
            <option value='23'>Custom House </option>
            <option value='8'>Custom House Quay </option>
            <option value='10'>Dame Street </option>
            <option value='59'>Denmark Street Great </option>
            <option value='45'>Deverell Place </option>
            <option value='11'>Earlsfort Terrace </option>
            <option value='12'>Eccles Street </option>
            <option value='79'>Eccles Street East </option>
            <option value='83'>Emmet Road </option>
            <option value='9'>Exchequer Street </option>
            <option value='48'>Excise Walk </option>
            <option value='63'>Fenian Street </option>
            <option value='89'>Fitzwilliam Square East </option>
            <option value='13'>Fitzwilliam Square West </option>
            <option value='14'>Fownes Street Upper </option>
            <option value='73'>Francis Street </option>
            <option value='98'>Frederick Street South </option>
            <option value='50'>George's Lane </option>
            <option value='16'>Georges Quay </option>
            <option value='17'>Golden Lane </option>
            <option value='69'>Grand Canal Dock </option>
            <option value='104'>Grangegorman Lower (Central) </option>
            <option value='105'>Grangegorman Lower (North) </option>
            <option value='103'>Grangegorman Lower (South) </option>
            <option value='18'>Grantham Street </option>
            <option value='57'>Grattan Street </option>
            <option value='4'>Greek Street </option>
            <option value='49'>Guild Street </option>
            <option value='68'>Hanover Quay </option>
            <option value='41'>Harcourt Terrace </option>
            <option value='61'>Hardwicke Place </option>
            <option value='15'>Hardwicke Street </option>
            <option value='55'>Hatch Street </option>
            <option value='19'>Herbert Place </option>
            <option value='47'>Herbert Street </option>
            <option value='92'>Heuston Bridge (North) </option>
            <option value='100'>Heuston Bridge (South) </option>
            <option value='94'>Heuston Station (Car Park) </option>
            <option value='93'>Heuston Station (Central) </option>
            <option value='7'>High Street </option>
            <option value='75'>James Street </option>
            <option value='40'>Jervis Street </option>
            <option value='72'>John Street West </option>
            <option value='71'>Kevin Street </option>
            <option value='115'>Killarney Street </option>
            <option value='97'>Kilmainham Gaol </option>
            <option value='96'>Kilmainham Lane </option>
            <option value='101'>King Street North </option>
            <option value='21'>Leinster Street South </option>
            <option value='62'>Lime Street </option>
            <option value='76'>Market Street South </option>
            <option value='78'>Mater Hospital </option>
            <option value='25'>Merrion Square East </option>
            <option value='113'>Merrion Square South </option>
            <option value='26'>Merrion Square West </option>
            <option value='27'>Molesworth Street </option>
            <option value='82'>Mount Brown </option>
            <option value='56'>Mount Street Lower </option>
            <option value='111'>Mountjoy Square East </option>
            <option value='28'>Mountjoy Square West </option>
            <option value='66'>New Central Bank </option>
            <option value='53'>Newman House </option>
            <option value='60'>North Circular Road </option>
            <option value='112'>North Circular Road (O'Connell's) </option>
            <option value='74'>Oliver Bond Street </option>
            <option value='29'>Ormond Quay Upper </option>
            <option value='86'>Parkgate Street </option>
            <option value='30'>Parnell Square North </option>
            <option value='31'>Parnell Street </option>
            <option value='32'>Pearse Street </option>
            <option value='110'>Phibsborough Road </option>
            <option value='34'>Portobello Harbour </option>
            <option value='43'>Portobello Road </option>
            <option value='33'>Princes Street / O'Connell Street </option>
            <option value='106'>Rathdown Road </option>
            <option value='85'>Rothe Abbey </option>
            <option value='95'>Royal Hospital </option>
            <option value='64'>Sandwith Street </option>
            <option value='58'>Sir Patrick's Dun </option>
            <option value='35'>Smithfield </option>
            <option value='42'>Smithfield North </option>
            <option value='91'>South Dock Road </option>
            <option value='81'>St. James Hospital (Central) </option>
            <option value='80'>St James Hospital (Luas) </option>
            <option value='36'>St. Stephen's Green East </option>
            <option value='37'>St. Stephen's Green South </option>
            <option value='46'>Strand Street Great </option>
            <option value='38'>Talbot Street </option>
            <option value='67'>The Point </option>
            <option value='22'>Townsend Street </option>
            <option value='44'>Upper Sherrard Street </option>
            <option value='102'>Western Way </option>
            <option value='77'>Wolfe Tone Street </option>
            <option value='39'>Wilton Terrace </option>
            <option value='114'>Wilton Terrace (Park) </option>
            <option value='52'>York Street East</option>
            <option value='51'>York Street West</option>
          </select>
          <br/>
          <input type="submit" class="submitbutton" value="Submit" onclick="display();">
          <br/>
          <br/>
          <hr/>
          <br/>
          <p id='chartsHeader' style="font-style:normal;"><b>Historical Charts & Predictions:</b></p>
      </form>
    </div>
    <div id='extraDropdownInfo'><!-- extra info here --></div>

    <!-- CHART 1 -->
    <br/>
    <canvas id="chart1" width="250" height="150"></canvas><br/><br/><br/>

    <!-- CHART 2 -->
    <canvas id="chart2" width="250" height="150"></canvas>

  </div>
  <!-- End margin container -->

  <div class="column">
		<div id="map"></div>
  </div>
</div>

<!-- MAP SCRIPT -->
<script>

  // bar chart data - next 4 hours based on past info
  var barData1 = {
    labels : [{% for item in times %}
                "{{item}}",
              {% endfor %}],
    datasets : [{
              fillColor: "rgba(151,187,205,0.2)",
              strokeColor: "rgba(151,187,205,1)",
              pointColor: "rgba(151,187,205,1)",
              data : [{% for item in qty %}
                        {{item}},
                      {% endfor %}]                 
    }]
  }

  var mychart1 = document.getElementById("chart1").getContext("2d");
  steps = 4;
  max = 40;
  new Chart(mychart1).Bar(barData1, {
    scaleOverride: true,
    scaleSteps: steps,
    scaleStepWidth: Math.ceil(max / steps),
    scaleStartValue: 0,
    scaleShowVerticalLines: true,
    scaleShowGridLines: true,
    barShowStroke: true,
    scaleShowLabels: true
  });

  // line graph data - days of week
  var barData2 = {
    labels : [{% for item in labels %}
                "{{item}}",
                {% endfor %}],
    datasets : [{
                fillColor: "rgba(151,187,205,0.2)",
                strokeColor: "rgba(151,187,205,1)",
                pointColor: "rgba(151,187,205,1)",
                data : [{% for item in day_values %}
                        {{item}},
                      {% endfor %}]
    }]
  }
  var mychart2 = document.getElementById("chart2").getContext("2d");
  steps = 4;
  max = 40;
  new Chart(mychart2).Line(barData2, {
    scaleOverride: true,
    scaleSteps: steps,
    scaleStepWidth: Math.ceil(max / steps),
    scaleStartValue: 0,
    scaleShowVerticalLines: true,
    scaleShowGridLines: true,
    barShowStroke: true,
    scaleShowLabels: true
  });

  // begin map function
  var map;
  function initMap() {
    var myLatLng = {lat: 53.348196, lng: -6.276942}
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 53.348196, lng: -6.276942},
      zoom: 14
    });

    /*pass in as a list instead of a whole string (safe instead of tojson)*/
    var markers = {{station_list | safe }};
    var infoWindow = new google.maps.InfoWindow({})
    var green = '/static/images/green-dot.png'
    var yellow = '/static/images/yellow-dot.png'
    var red = '/static/images/red-dot.png'

    var standicon = '<img src="/static/images/parking.svg" width="23px" height="23px">'
    var bikeicon = '<img src="/static/images/bicycle.svg" width="23px" height="23px">'
    var cardicon = '<img src="/static/images/baseline-credit_card-24px.svg" width="23px" height="23px">'
    var timeicon = '<img src="/static/images/time.svg" width="23px" height="23px">'

    for (var i = 0; i < markers.length; i++){
      var pos = new google.maps.LatLng(parseFloat(markers[i].latitude), parseFloat(markers[i].longitude));
      var currentIcon;
      var allstands = markers[i].available_bikes + markers[i].available_bike_stands
      if (markers[i].available_bikes/allstands >= 0.7) {
        currentIcon = green;
      } else if ((markers[i].available_bikes/allstands  >= 0.3) && (markers[i].available_bikes/allstands  < 0.7)) {
        currentIcon = yellow;
      } else if (markers[i].available_bikes/allstands  < 0.3) {
        currentIcon = red;
      }

      var time = markers[i].last_update
      let formattime = new Date(time);
      var formatmins = formattime.getMinutes().toString()

      if (formatmins.length == 1) {
        var mins = '0' + formatmins;
      } else {
        var mins = formatmins;
      }

      var formattedtime = formattime.getHours() + ":" + formatmins;


      console.log(formattime.getHours())

      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: currentIcon,
        title: markers[i].name,
        animation: google.maps.Animation.DROP
      })
      marker.addListener('click', function() {
        map.setZoom(17);
        map.setCenter(marker.getPosition());
        document.getElementById('chart1').style.display="None"
        document.getElementById('chart2').style.display="None"
      });
      google.maps.event.addListener(
        marker,
        'click',
        (function(marker, i) {
          return function() {
          
            // SOURCE: https://codepen.io/Marnoto/pen/xboPmG - formatting infoWindow
            var contentString = '<div id="iw-container">' +
              '<div class="iw-title">Most recent information:</div>' +
              '<div class="iw-content">' +
              '<div class="iw-subTitle">' + markers[i].name + '</div>' + 
              'Number of bikes to ride: ' + markers[i].available_bikes + 
              '<br>Number of bike stands empty: ' + markers[i].available_bike_stands + 
              '<br>Last update: ' + formattedtime +
              '</div>' +
              '<div class="iw-bottom-gradient"></div>' +
              '</div>';

            var sideContent = '<p id="extraInfoHeader" style="font-style:normal;"><b>Most recent information:</p><br/><p style="text-align: center;" ><b>' 
              + markers[i].address + "</b></p><br/><hr/><br/><p>"
              + bikeicon + '&nbsp;&nbsp;&nbsp;&nbsp; Available bikes: ' + markers[i].available_bikes + '<br/>'
              + standicon + '&nbsp;&nbsp;&nbsp;&nbsp; Available stands: ' + markers[i].available_bike_stands + '<br/>'
              + timeicon + '&nbsp;&nbsp;&nbsp;&nbsp; Last update: ' + formattedtime + '<br/>';
              if (markers[i].banking == 1) {
                sideContent += cardicon + '&nbsp;&nbsp;&nbsp;&nbsp; Pay by card: Yes';
              } else {
                sideContent += cardicon + '&nbsp;&nbsp;&nbsp;&nbsp; Pay by card: No';
              }
            sideContent += '</p>';
            infoWindow.setContent(contentString)
            infoWindow.open(map, marker)
            document.getElementById("extraDropdownInfo").innerHTML = sideContent;
            document.getElementById("extraDropdownInfo").style.display = "block";
            document.getElementById("chartsHeader").style.display = "none";

          }
        })(marker, i)
      )
    }

    // SOURCE: https://codepen.io/Marnoto/pen/xboPmG - formatting infoWindow
    google.maps.event.addListener(infoWindow, 'domready', function() {
      var iwOuter = $('.gm-style-iw');
      var iwBackground = iwOuter.prev();
      iwBackground.children(':nth-child(2)').css({'display' : 'none'});
      iwBackground.children(':nth-child(4)').css({'display' : 'none'});
      iwOuter.parent().parent().css({left: '115px'});
      iwBackground.children(':nth-child(1)').attr('style', function(i,s){ return s + 'left: 76px !important;'});
      iwBackground.children(':nth-child(3)').attr('style', function(i,s){ return s + 'left: 76px !important;'});
      iwBackground.children(':nth-child(3)').find('div').children().css({'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index' : '1'});
      var iwCloseBtn = iwOuter.next();
      iwCloseBtn.css({opacity: '1', right: '38px', top: '3px', border: '7px solid #48b5e9', 'border-radius': '13px', 'box-shadow': '0 0 5px #3990B9'});
      if($('.iw-content').height() < 140){
        $('.iw-bottom-gradient').css({display: 'none'});
      }
      iwCloseBtn.mouseout(function(){
        $(this).css({opacity: '1'});
      });
    });

    // geolocation
    // if (navigator.geolocation) {
    //   navigator.geolocation.getCurrentPosition(function(position) {
    //     var pos = {
    //       lat: position.coords.latitude,
    //       lng: position.coords.longitude
    //     };
    //     infoWindow.setPosition(pos);
    //     infoWindow.setContent('Your current location.');
    //     infoWindow.open(map);
    //     map.setCenter(pos);
    //   }, function() {
    //     handleLocationError(true, infoWindow, map.getCenter());
    //   });
    // } else {
    //   // Browser doesn't support Geolocation
    //   handleLocationError(false, infoWindow, map.getCenter());
    // }
  }
  
  // script for displaying current weather
  $.ajax({
    url: "http://api.openweathermap.org/data/2.5/weather?units=metric",
    jsonp: "callback",
    dataType: "jsonp",
    data: {
      id: "7778677",
      APPID: "f189dc2a9a2453baec98286f49d36183"
    },
    success: function( response ) {
      console.log( response ); // server response
      $('.current').html('<p>Current weather:</p><img class="currentw" src="http://openweathermap.org/img/w/' + response.weather[0].icon + '.png" />' + '<p class="currentw">' + response.main.temp + '&#8451</p>');
    }
  });

  //geolocation error function
  // function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  //   infoWindow.setPosition(pos);
  //   infoWindow.setContent(browserHasGeolocation ?
  //                         'Error: The Geolocation service failed.' :
  //                         'Error: Your browser doesn\'t support geolocation.');
  //   infoWindow.open(map);
  // }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCavW5Ssi8LxuHtrKVg2vmdVkmoEm_VbBg&callback=initMap"
    async defer></script>

<!-- Footer -->
<div class="footer">
  <p>Copyright &#169 Candis, Natasha and Martin 2019</p>
</div>
</body>
</html>